<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Asset Management - Auth</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #4facfe, #00f2fe);
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }
    .auth-container {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(12px);
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
      width: 400px;
      text-align: center;
      color: #fff;
    }
    h2 { margin-bottom: 15px; font-weight: 600; }
    input, select {
      width: 100%; padding: 12px; margin: 10px 0;
      border: none; border-radius: 8px; outline: none; font-size: 14px;
    }
    input:focus, select:focus { border: 2px solid #00f2fe; background-color: rgba(255,255,255,0.9); }
    button {
      width: 100%; padding: 12px; margin-top: 10px;
      background: linear-gradient(90deg, #00c6ff, #0072ff);
      border: none; border-radius: 8px; color: white; font-size: 16px;
      font-weight: 600; cursor: pointer; transition: 0.3s;
    }
    button:hover { background: linear-gradient(90deg, #0072ff, #00c6ff); transform: translateY(-2px); }
    .link { margin-top: 12px; display: block; color: #fff; cursor: pointer; font-size: 14px; text-decoration: underline; }
    #msg, #fpMsg { margin-top: 15px; font-size: 14px; color: #ffdddd; }
    .hidden { display: none; }
  </style>
</head>
<body>

<div class="auth-container">

  <!-- Login Form -->
  <div id="loginForm">
    <h2>üîê Police Station Login</h2>
    <select id="policeStation"></select>
    <input type="email" id="loginEmail" placeholder="Email" readonly>
    <input type="password" id="loginPassword" placeholder="Password" disabled>
    <button onclick="login()">Login</button>
    <span class="link" onclick="showForgot()">Forgot Password?</span>
    <p id="msg"></p>
  </div>

  <!-- Forgot Password Form -->
  <div id="forgotForm" class="hidden">
    <h2>üì© Forgot Password</h2>
    <select id="fpStation"></select>
    <input type="email" id="fpEmail" placeholder="Email" readonly>
    <button onclick="sendOTP()">Send OTP</button>

    <div id="otpSection" class="hidden">
      <input type="text" id="fpOtp" placeholder="Enter OTP">
      <input type="password" id="newPassword" placeholder="New Password">
      <button onclick="resetPassword()">Reset Password</button>
    </div>

    <span class="link" onclick="showLogin()">üîô Back to Login</span>
    <p id="fpMsg"></p>
  </div>

</div>

<script defer>
const API_BASE = "http://localhost:5000";

// Station emails mapping
const stationEmails = {
  "Gadag Town PS": "towngdg@ksp.gov.in",
  };

// Populate station dropdowns
function populateStations(selectId) {
  const select = document.getElementById(selectId);
  if (!select) return;
  select.innerHTML = "<option value=''>-- Select Station --</option>";
  Object.keys(stationEmails).sort().forEach(station => {
    const opt = document.createElement("option");
    opt.value = station;
    opt.textContent = station;
    select.appendChild(opt);
  });
}

window.addEventListener("DOMContentLoaded", () => {
  populateStations("policeStation");
  populateStations("fpStation");

  document.getElementById("policeStation").addEventListener("change", e => {
    const station = e.target.value;
    const email = stationEmails[station] || "";
    document.getElementById("loginEmail").value = email;
    document.getElementById("loginPassword").disabled = !email;
  });

  document.getElementById("fpStation").addEventListener("change", e => {
    const station = e.target.value;
    document.getElementById("fpEmail").value = stationEmails[station] || "";
  });
});

// Login function
async function login() {
  const email = document.getElementById("loginEmail").value.trim().toLowerCase();
  const password = document.getElementById("loginPassword").value.trim();
  const msgEl = document.getElementById("msg");
  msgEl.innerText = "";

  if (!email || !password) {
    msgEl.style.color = "#ffdddd";
    msgEl.innerText = "‚ö†Ô∏è Select a station and enter password.";
    return;
  }

  try {
    const res = await fetch(`${API_BASE}/auth/login`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, password })
    });
    const data = await res.json();

    if (res.ok) {
      // ‚úÖ Save JWT token for authenticated pages
      localStorage.setItem("token", data.token);
      localStorage.setItem("currentUserEmail", email);

      msgEl.style.color = "#00ff99";
      msgEl.innerText = "‚úÖ Login successful! Redirecting...";
      setTimeout(() => window.location.href = "dashboard.html", 1000);
    } else {
      msgEl.style.color = "#ffdddd";
      msgEl.innerText = `‚ùå ${data.message || "Login failed"}`;
    }
  } catch (err) {
    console.error("Login error:", err);
    msgEl.style.color = "#ffdddd";
    msgEl.innerText = "‚ö†Ô∏è Server error. Try again later.";
  }
}

// Forgot Password functions
async function sendOTP() {
  const email = document.getElementById("fpEmail").value.trim().toLowerCase();
  const fpMsg = document.getElementById("fpMsg");
  fpMsg.innerText = "";

  if (!email) {
    fpMsg.style.color = "#ffdddd";
    fpMsg.innerText = "‚ö†Ô∏è Select a station first.";
    return;
  }

  try {
    const res = await fetch(`${API_BASE}/auth/request-otp`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email })
    });
    const data = await res.json();
    if (res.ok) {
      fpMsg.style.color = "#00ff99";
      fpMsg.innerText = "‚úÖ OTP sent to email.";
      document.getElementById("otpSection").classList.remove("hidden");
    } else {
      fpMsg.style.color = "#ffdddd";
      fpMsg.innerText = data.message || "‚ùå Failed to send OTP";
    }
  } catch (err) {
    console.error("sendOTP error:", err);
    fpMsg.style.color = "#ffdddd";
    fpMsg.innerText = "‚ö†Ô∏è Server error sending OTP.";
  }
}

async function resetPassword() {
  const email = document.getElementById("fpEmail").value.trim().toLowerCase();
  const otp = document.getElementById("fpOtp").value.trim();
  const newPassword = document.getElementById("newPassword").value.trim();
  const fpMsg = document.getElementById("fpMsg");
  fpMsg.innerText = "";

  if (!otp || !newPassword) {
    fpMsg.style.color = "#ffdddd";
    fpMsg.innerText = "‚ö†Ô∏è Enter OTP and new password.";
    return;
  }

  try {
    const res = await fetch(`${API_BASE}/auth/reset-password`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, otp, newPassword })
    });
    const data = await res.json();
    if (res.ok) {
      fpMsg.style.color = "#00ff99";
      fpMsg.innerText = "‚úÖ Password reset successful. Redirecting...";
      setTimeout(showLogin, 2000);
    } else {
      fpMsg.style.color = "#ffdddd";
      fpMsg.innerText = data.message || "‚ùå Reset failed";
    }
  } catch (err) {
    console.error("resetPassword error:", err);
    fpMsg.style.color = "#ffdddd";
    fpMsg.innerText = "‚ö†Ô∏è Server error. Try again later.";
  }
}

// Toggle forms
function showForgot() {
  document.getElementById("loginForm").classList.add("hidden");
  document.getElementById("forgotForm").classList.remove("hidden");
}

function showLogin() {
  document.getElementById("forgotForm").classList.add("hidden");
  document.getElementById("loginForm").classList.remove("hidden");
  document.getElementById("fpOtp").value = "";
  document.getElementById("newPassword").value = "";
  document.getElementById("otpSection").classList.add("hidden");
  document.getElementById("fpMsg").innerText = "";
}
</script>

</body>
</html>
